:scrollbar:
:toc2:


== Red Hat Process Automation Manager Workshop
This workshop is aimed at providing hands on experience creating Decision and Process Assets. This lab will implement a Loan Approval workflow. 

.Goals
* Define and create the process domain model using the platform's Data Modeller.
* Create a Loan Approval workflow.
* Create an Age Pre-Qualification Decision using Guided Rules
* Create an Interest Calculation decision using XLS Decision table.
* Create a Loan Pre-Qualification Decision using Guided Decision tables.
* Create Task forms for human tasks.
* Deploying and Management of the Loan Approval Process


.Prerequisite
* Successful completion of the _Environment Setup Lab_
or
* An existing, accessible, DM/PAM 7.3+ environment.

:numbered:

== Problem Statement
In this lab we will create an Loan Approval process.

* Customer initiates the Loan Approval request. 
* Age and Pre Qualification checks are applied to the loan request.
* If the pre-qualification was succesful, then the request is assigned to a loan manager for approval.

== Create a Project
To define and deploy a business process, we first need to create a new project in which we can store the BPMN2 model, our domain model and the forms required for user interaction. To create a new project:

. Navigate to {business_central}
. Login to the platform with the provided username and password.
. Click on **Design** to navigate to the Design perspective.
+
image:images/space_view.jpg[]
+

. In the Design perspective, create a new project. If your space is empty, this can be done by clicking on the blue **Add Project** button in the center of the page. If you already have projects in your space, you can click on the blue **Add Project** icon at the top right of the page.
. Give the project the name `loan-approval`, and the description "Loan Approval Process".
+
image:images/create_project.jpg[]
+

With the project created, we can now start building our solution.

== Solution

=== The Domain Model

The business process will collect and carry data through the execution of the process. This data is stored in a data model or domain model.
In this lab, we collect two types of data:

* `Applicant`: contains information about the Applicant, like age, credit score, monthly income etc.
* `Loan`: contains information about the Loan request, like the loan duration and the Loan amount.

. In your project, click on the _Add Asset_ button in the middle of the screen.
+

image:images/add_asset.jpg[]
. In the drop-down menu in the upper-left corner, select `Model`. Click on the _Data Object_ tile.
+
image:images/add_asset_model.jpg[]
. Give the _Data Object_ the name `Applicant`. Leave the package set to default.
+
image:images/data_obj_create.jpg[]
. Add the following fields to the `Applicant` data object by clicking on the _+ add field_ button:
+

`Applicant`
+
|===========
|Identifier|Label|Type

|age|Age|Integer
|creditScore|Credit Score|Integer
|monthlyIncome|Monthly Income|Double
|yearlyIncome|Yearly Income|Double
|name|Name|String
|===========
+


. When you've added the fields, save the data object by clicking on the _Save_ button in the top menu.
After creation the `Applicant` Model should look like this.
+
image:images/applicant_overview.jpg[]

. Use the _breadcrumb navigator at the top-left of the screen to navigate back to our `loan-approval` project.
. Click on the blue _Add Asset_ button in the top-right corner and create a new _Data Object_. Give it the name `Loan`
+
image:images/loan_obj_create.jpg[]
. Give the `Loan` object the following fields:
+
`Loan`
+
|===========
|Identifier|Label|Type

|amount|Amount|double
|duration|Duration|Integer
|interestRate|Interest Rate|Double
|monthlyRepayment|Monthly Repayment|Double
|agePreQual|Age PreQualification|boolean
|loanPreQualification|Loan PreQualification|boolean
|comment|comment|String

|===========
When you've added the fields, save the data object by clicking on the _Save_ button in the top menu.
After creation the `Applicant` Model should look like this.
+
image:images/loan_obj_save.jpg[]
+
We're done creating our data model.
+
image:images/assets_lib.jpg[]

We can now create the required decisions for our process.

=== Creating the Age Pre-Qualification Decision

First let us create a simple Age Pre Qualification decision. The rule will do a simple check to ensure the Applicant's age is between 18 and 70.

. Click on the _Add Asset_ button and choose the `Guided Rule` asset. Name it `AgePreQualification`.
+
image:images/age_pre_qual_create.jpg[]
+

> . Guided Rules are suited for individual rules that can be created in a UI-based rule designer in Decision Central
> . Provide fields and options for acceptable input
> . Are optimal for creating single rules in a controlled format to minimize compilation errors
+
. When the Guided edior opens up, click on the + icon on the right corner of the editor screen.
+
image:images/guided_rule_step1.jpg[]
+
Let us first import the Applicant Object as below.
+
image:images/guided_rule_step2.jpg[]
+
. Now again click on the first green + icon as we did in the previous step and choose the Loan Object.
+
image:images/guided_rule_step3.jpg[]
+
We have imported the required input objects.
+
. Next, click on step 1

+
image:images/guided_rule_step4.jpg[]
+
. Select the _All of (And)_ option in the Multiple field constraint field.
+
image:images/guided_rule_step5.jpg[]
+
. Next we will add the conditions. For this click on the _all of the following:_ displayed below the Applicant Object.
image:images/guided_rule_step6.jpg[]
+
. We will add the conditions now. We would need the age to be greater than 18 and less than 82. Let us do that by selecting age from the _Add a restriction on a field_ drop down.

+
image:images/guided_rule_step7.jpg[]

+
. This should add the age field on the editor
Now select the _greater than_ option from the drop down and click on the small pencil icon next to the drop down.
+
image:images/guided_rule_step8.jpg[]
+
. We will enter 18 here to indicate the condition, similarly we will add a condition for less than 70 as well.

+
image:images/guided_rule_step9.jpg[]
+
. Next let us click on the 2nd Step which is _There is a Loan_. 
+
image:images/guided_rule_step11.jpg[]
+
. We will enter an alias for this Loan object as below
+
image:images/guided_rule_step12.jpg[]
+
. Now we have finished defining all the conditions, let us now define the action. Let us click on the green icon to add the _Then_ clause.
+
image:images/guided_rule_step10.jpg[]
+
. Here we will select the option for _Change field values of Loan_
+
image:images/guided_rule_step13.jpg[]
+
. Next let us click on the pencil icon to tell the editor which field to choose. We will choose the field `agePreQual` and choose ok. Subsequently we again choose the pencil icon next to the field and set the value as true. Your result should look like below.
+
image:images/guided_rule_step14.jpg[]
+
. Finally we will do one last thing here, since the rules are going to orchestrated using a business process, we will provide it an identifier called _Rule Flow Group_. For this click on the _show options_ link.

+
image:images/guided_rule_step15.jpg[]
+
image:images/guided_rule_step16.jpg[]
+
. We will choose the attribute _ruleflow-group_ from the drop down and click on ok. We will enter `age_qualification` for the value of attribute.

+
image:images/guided_rule_step17.jpg[]
+ 
. We are all done now. We can now click on _Save_ to save the rule and clicking on _Validate_. This should end up being succesful.
+

. Next let us setup a test for testing this rule artifact. 
+
. For this go back to the asset library view, and choose the _Add Asset_ button. We will choose the artifact type _Test Scenario_. 
+
image:images/guided_rule_step18.jpg[]
+
. On the Test Scenario editor, we provide the _Given_ and the _Then_ clauses. On the right side pane we have the objects listed. Click on the Given Object type and choose the Applicant object from the right pane. We will choose the `age` field.
+
image:images/guided_rule_step19.jpg[]
+
. Now we will click on the Applicant column under _Given_ and using the context option add a new column to the right. Here, we will choose _Loan_. Finally click on the _Then_ column and add the object _Loan_. Here we will choose the field `agePreQual`. 
+
image:images/guided_rule_step20.jpg[]
+
image:images/guided_rule_step21.jpg[]
+
. Next let us inform the test editor which _Rule Flow Group_ we are testing with. For this click on the settings option from the right side pane.
+
image:images/guided_rule_step22.jpg[]
+
. Enter the value for the Rule Flow Group as `age_qualification`.
+
. Now we can add values to the various columns by editing the cells similar to spread sheet editing.
+
image:images/guided_rule_step23.jpg[]
+
. Once done, click on the _Test_ button to test the rules. As shown in the image above by clicking on the metrics option from the right side pane, we can see coverage reports show up as well. Finally save the artifact.

Congratulations! We have now created our first artifact.

=== Creating the Interest Calculation

. We will now use another authoring format to create the Interest Rate Calculation table. 
+

> . Uploaded Decision tables are XLS or XLSX decision table spreadsheets that you upload into Decision Central
> . Support template keys and values for creating rule templates
> . Are optimal for creating rules in decision tables already managed outside of Decision Central
Have strict syntax requirements for rules to be compiled properly when uploaded
+
Spreadsheets require two key areas that define rule data: a RuleSet area and a RuleTable area. The RuleSet area of the spreadsheet defines elements that you want to apply globally to all rules in the same package (not only the spreadsheet), such as a rule set name or universal rule attributes. The RuleTable area defines the actual rules (rows) and the conditions, actions, and other rule attributes (columns) that constitute that rule table within the specified rule set. A decision table spreadsheet can contain multiple RuleTable areas, but only one RuleSet area.

. For the purpose of this excercise, you can download the template available here. 
+
link:resources/interest_rate_calculation.xls[Interest Rate calculation]

+ 
Your spread sheet should look like this. 
+
image:images/spread_sheet_1.jpg[]
+
. Let us now inspect the values. The ruleset section defines the _Rule Set name_, the _Rule Flow Group_ and import to specify the object which we will be making use of(which in this case is Loan).
+
The condition columns define the logic for identifying the Interest Rate. We also calculate the Monthly Repayment based on the amount.

. Let us now define the values _RuleTable_ as below.  Edit the downloaded spread sheet and enter these values.
+
|===========
|Min Amount|Max Amount|Duration(years)|Interest Rate

||300000|7|0.47
|300000|600000|7|0.70
|600000||7|0.98
||300000|10|0.72
|300000|600000|10|0.90
|600000||10|1.10

||300000|20|1.25
|300000|600000|20|1.39
|600000||20|1.65

|===========
+
Once done, we will upload it to Business Central
. Now select the _Add Asset_ button from the asset libary page and choose Decision Table(Spreadsheet)

+
image:images/spread_sheet_2.jpg[]
+

select the file which we edited in the previous step. This should create the artifact succesfully.

=== Creating the Loan Pre Qualification Decision

Now we will do a Loan Pre Qualification check based on the loan amount, Debt Ratio and Credit Score. 

We will now the _Guided Decision Table_ asset.

> . Guided Decison are rules that you create in a UI-based table designer in Decision Central
> . Are a wizard-led alternative to uploaded decision table spreadsheets
> . Provide fields and options for acceptable input

. Now go back to the asset library and click on _Add Asset_ button. Choose the Guided Decision Table option.

+
image:images/guided_dtable_1.jpg[]
+

> Hit policies determine the order in which rules (rows) in a guided decision table are applied, whether top to bottom, per specified priority, or other options. 
+
For this example, we will leave it as the default selection.
+
Guided Decision tables provide wizard based approach to defining condition and action columns.
+
On the Guided Decision Table editor click on the Columns Tab.
+

image:images/guided_dtable_2.jpg[]


. First we will define a condition column to check for Min Loan Amount check. To Add a condition colum click on the _Insert Column_ button. This will open up the wizard. Choose the _Add a Condition_ option and click on _Next_
+
image:images/guided_dtable_3.jpg[]
+

First we need to import the data objects which we will be using for the rule. For this click on the _Create a new Fact Pattern_ button.
+
Choose the `Loan` type and provide a binding variable.

+
image:images/guided_dtable_4.jpg[]
+
Next let us define the Calculation type, we will choose the _Literal Value_ and proceed.
+
image:images/guided_dtable_5.jpg[]
+
We will choose the amount field.
+
image:images/guided_dtable_6.jpg[]
+
Since we need to define the Min Amount check, we will choose the operation as `greater than` and proceed.
+
image:images/guided_dtable_7.jpg[]
+
Finally we will give the column a header name and save the column definition.
+
image:images/guided_dtable_8.jpg[]
. Next we will define the Max Loan Amount column, repeat the same steps as above but choose the operation type as `less than` instead.
+
image:images/guided_dtable_20.jpg[]
+
. Next let us define the Debt ratio.
+
Since Debt Ratio is a calculation based on the Applicant's data. We will need to import the `Applicant` type and create a binding.
+
image:images/guided_dtable_9.jpg[]
+
image:images/guided_dtable_10.jpg[]
+
Since this is a Formula and we need to make checks based on the Formula we will use the _Predicate_ option and proceed.
+
Enter the formula in the predicate field followed by $param. This will mean that
the evaulation of the Formula provided will be checked against the condition defined on the column and will evaluate to True/False.
+
The Debt ratio uses the `monthlyRepaymentAmount` as calculated in the XLS spread sheet decision table with this formula:
100*(loan.getMonthlyRepayment()/this.getMonthlyIncome())
+
image:images/guided_dtable_11.jpg[]
+
We will proceed along the wizard with default values and finally define a Header description.
+
image:images/guided_dtable_12.jpg[]
+
. Next we will need to create two columns for Max Credit Score and Min Credit Score. `creditScore` is a field in the _Applicant_ Object. Follow the pattern we did for defining the Max and Min Loan Amount to define these columns.
. Now we need to define the _Action_ columns. For this click on _Insert Column_ and choose the value _Set the value of a field_ and hit next.
+
image:images/guided_dtable_13.jpg[]
+
We will set the value of `loanPreQualification` in the _Loan_ Object to a true/false. 
+
image:images/guided_dtable_14.jpg[]
+
Follow along the rest of the field with default values and define a header description.
. We will define one more field which will provide reason for qualification/disqualification. For this click on _Insert Column_ option and choose the _Insert Column_ option. Choose the field `comment` of the _Loan_ Object and proceed. We will define an allowed set of values to provide a pre-filled drop down on the guided decision table editor. 
+
image:images/guided_dtable_15.jpg[]
+ 
Proceed along the editor with default values and define a header for the field and finsih saving the action column definition.
. We will need to define the _Rule Flow Group_ for the rule definition that we created here. For this, expand the _Attribute Coumns_ and define the value for the `ruleflow-group` as below.
+
image:images/guided_dtable_19.jpg[]
. Switch back to the Model Tab and finally our table should look like this.
+
image:images/guided_dtable_16.jpg[]
+
. We will now enter the values for the decision table. For this click on the Insert button on the top right and click on _Append row_
+
image:images/guided_dtable_21.jpg[]
+
. Fill in the table values as given below. Notice that for the Reason Column the value is available as a drop down and the Loan Pre Qualification column shows up as check box because of its boolean nature.
+
image:images/guided_dtable_17.jpg[width=200%]
+
. Now Save the decision and click on _Validate_. To test the decision, let us import a _Test Scenario_ which we have created already.
Download the test file from here.
+
link:resources/TestPreQualification.scesim[Test Pre Qualification]
+
Click on the _Import Asset_ and choose this file.
+
image:images/guided_dtable_18.jpg[]
+
Now Click on _Test_ to ensure they are no errors.
Congratulations! We have now created all of the decisions needed for our process flow.









